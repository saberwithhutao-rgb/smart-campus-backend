spring:
  mvc:
    throw-exception-if-no-handler-found:
  web:
    resources:
      add-mappings: false
  # 数据源配置 - 使用你的实际用户名和密码
  datasource:
    url: jdbc:postgresql://localhost:5432/smart_campus
    username: smartcampus_app
    password: SmartCampus2024
    hikari:
      pool-name: SmartCampusHikariPool
      maximum-pool-size: 20
      minimum-idle: 10
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000
#      connection-test-query: SELECT 1
      data-source-properties:
        ssl: false
        socketTimeout: 30
        loginTimeout: 10
        tcpKeepAlive: true
        readOnly: false

  # JPA配置
  jpa:
    hibernate:
      ddl-auto: validate  # 生产环境用validate，不用update
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          batch_size: 20
          fetch_size: 50
        order_inserts: true
        order_updates: true
        batch_versioned_data: true
    open-in-view: false  # 生产环境关闭

  # 邮件配置
  mail:
    host: ${MAIL_HOST:gz-smtp.qcloudmail.com}
    port: ${MAIL_PORT:465}
    username: ${MAIL_USERNAME:noreply@55kjikj.xyz}
    password: ${MAIL_PASSWORD:NagatoYuki154}
    protocol: smtps
    properties:
      mail:
        smtp:
          auth: true
          ssl:
            enable: true  # 465端口必须启用SSL
          connectiontimeout: 10000
          timeout: 10000
          writetimeout: 10000

  # Redis配置
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 5000
      database: 1  # 使用1号库存储AI缓存

  # 文件上传配置（Spring Boot内置）
  servlet:
    multipart:
      enabled: true
      max-file-size: 50MB
      max-request-size: 50MB
      file-size-threshold: 2KB

# 服务器配置
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path:  # ⚠️ 重要：清空这个！保持为空字符串
    # 因为TestController已经有@RequestMapping("/api")了

# 日志配置
logging:
  level:
    root: INFO
    com.zaxxer.hikari: DEBUG
    org.postgresql: INFO
    org.postgresql.jdbc: INFO
    com.smartcampus: DEBUG
    com.smartcampus.controller.AiQaController: TRACE
    org.springframework.web: DEBUG
    org.springframework.web.multipart: TRACE
    org.springframework.web.multipart.support: TRACE
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql: WARN
  file:
    name: /var/log/smart-campus/backend-detailed.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 30

# JWT配置
jwt:
  secret: smart-campus-jwt-secret-key-2024-change-this-in-production
  expiration: 86400000  # 24小时，单位毫秒

# AI相关配置
ai:
  qianwen:
    api-key: ${AI_QIANWEN_API_KEY:sk-131e010e2b4a4fd3a7c41ef3e3ae10d8}
    api-url: ${AI_QIANWEN_API_URL:https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions}
    timeout: 90000
    model: qwen-max  # 固定模型，按你要求

  embedding:
    model: text-embedding-v2
    chunk-size: 500
    chunk-overlap: 50

  rag:
    top-k: 3  # 检索最相关的3个片段
    similarity-threshold: 0.7  # 相似度阈值

  task:
    timeout: 300000  # 5分钟超时
    max-concurrent: 10

# 自定义文件上传配置（供业务代码使用）
file:
  upload:
    max-size: 50MB
    allowed-types: pdf,doc,docx,txt
    storage:
      location: /opt/smart-campus/uploads

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
      base-path: /actuator
  endpoint:
    health:
      show-details: when_authorized
      probes:
        enabled: true
      db:
        enabled: true